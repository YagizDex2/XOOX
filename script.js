let currentPlayer = 'üêù';
let gameBoard = ['', '', '', '', '', '', '', '', ''];
let gameActive = true;
let beeCount = 0;
let honeyCount = 0;
let selectedCell = null;
let beeScore = 0;
let honeyScore = 0;

const statusDisplay = document.getElementById('status');
const cells = document.querySelectorAll('.cell');
const restartBtn = document.getElementById('restartBtn');
const clickSound = document.getElementById('clickSound');
const backgroundMusic = document.getElementById('backgroundMusic');
const volumeSlider = document.getElementById('volumeSlider');
const winnerDisplay = document.getElementById('winnerDisplay');
const winnerEmoji = document.querySelector('.winner-emoji');
const winnerText = document.querySelector('.winner-text');
const beeVictorySound = document.getElementById('beeVictorySound');
const honeyVictorySound = document.getElementById('honeyVictorySound');
const beeScoreDisplay = document.getElementById('beeScore');
const honeyScoreDisplay = document.getElementById('honeyScore');
const resetScoresBtn = document.getElementById('resetScores');
const beeMovesLeft = document.getElementById('beeMovesLeft');
const honeyMovesLeft = document.getElementById('honeyMovesLeft');
const muteButton = document.getElementById('muteButton');
let previousVolume = 0.25; // Varsayƒ±lan ses seviyesi

// Oyun durumunu takip etmek i√ßin yeni deƒüi≈ükenler
let isExpandedBoard = false;  // Tahta geni≈ületildi mi?
let extraPieceAdded = false; // Ekstra ta≈ü eklendi mi?

// Tahta boyutunu takip etmek i√ßin yeni deƒüi≈üken
let boardSize = 3;

// Global deƒüi≈ükenler kƒ±smƒ±na ekleyelim
let winConditions = [
    [0, 1, 2], [3, 4, 5], [6, 7, 8],  // Yatay
    [0, 3, 6], [1, 4, 7], [2, 5, 8],  // Dikey
    [0, 4, 8], [2, 4, 6]              // √áapraz
];

// Oyun modu deƒüi≈ükeni
let isClassicMode = true;

// Skorlarƒ± ayrƒ± tutmak i√ßin yeni deƒüi≈ükenler ekleyelim
let classicScores = { x: 0, o: 0 };
let beeScores = { bee: 0, honey: 0 };

// √úst √ºste kazanma sayƒ±sƒ±nƒ± tutmak i√ßin yeni deƒüi≈ükenler
let consecutiveWins = {
    x: 0,
    o: 0,
    bee: 0,
    honey: 0
};

// DOM elementleri
const gameModeSelect = document.getElementById('gameModeSelect');
const gameContainer = document.getElementById('gameContainer');
const classicModeBtn = document.getElementById('classicMode');
const beeModeBtn = document.getElementById('beeMode');
const switchModeBtn = document.getElementById('switchMode');
const currentModeText = document.getElementById('currentMode');
const mainMenu = document.getElementById('mainMenu');
const optionsMenu = document.getElementById('optionsMenu');
const playButton = document.getElementById('playButton');
const optionsButton = document.getElementById('optionsButton');
const backFromOptions = document.getElementById('backFromOptions');
const backToMenu = document.getElementById('backToMenu');
const backToMainMenu = document.getElementById('backToMainMenu');
const musicIcon = document.querySelector('.music-icon');
const slider = document.querySelector('.slider');
let sliderTimeout;
let isSliderDragging = false;

// Mod se√ßim olaylarƒ±
classicModeBtn.addEventListener('click', () => startGame(true));
beeModeBtn.addEventListener('click', () => startGame(false));

// Ana men√º olaylarƒ±
playButton.addEventListener('click', () => {
    mainMenu.style.display = 'none';
    gameModeSelect.style.display = 'block';
});

optionsButton.addEventListener('click', () => {
    mainMenu.style.display = 'none';
    optionsMenu.style.display = 'block';
});

// Geri d√∂n√º≈ü butonlarƒ±
backFromOptions.addEventListener('click', () => {
    optionsMenu.style.display = 'none';
    mainMenu.style.display = 'block';
    document.body.classList.add('menu-open');
});

backToMenu.addEventListener('click', () => {
    gameModeSelect.style.display = 'none';
    mainMenu.style.display = 'block';
    document.body.classList.add('menu-open');
});

backToMainMenu.addEventListener('click', () => {
    document.body.classList.add('menu-open');
    gameContainer.style.display = 'none';
    mainMenu.style.display = 'block';
    // Oyunu sƒ±fƒ±rla
    restartGameWithoutMusic();
    // M√ºziƒüi durdur
    backgroundMusic.pause();
    backgroundMusic.currentTime = 0;
});

// Sayfa y√ºklendiƒüinde
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('menu-open');
    mainMenu.style.display = 'block';
    gameModeSelect.style.display = 'none';
    gameContainer.style.display = 'none';
    optionsMenu.style.display = 'none';
});

function startGame(isClassic) {
    document.body.classList.remove('menu-open');
    isClassicMode = isClassic;
    gameModeSelect.style.display = 'none';
    gameContainer.style.display = 'block';
    document.body.classList.remove('mode-select');
    
    // Oyun ba≈ülangƒ±cƒ±nda m√ºziƒüi ba≈ülat
    if (backgroundMusic.paused) {
        backgroundMusic.play();
    }
    
    // Oyun ba≈ülangƒ±cƒ±nda t√ºm consecutive win saya√ßlarƒ±nƒ± sƒ±fƒ±rla
    consecutiveWins = { x: 0, o: 0, bee: 0, honey: 0 };
    
    // ƒ∞lk oyuncu se√ßimi
    currentPlayer = isClassic ? '‚ùå' : 'üêù';
    
    // Oyunu ba≈ülat
    restartGame();
    
    // Mod deƒüi≈ütirme butonunu g√∂ster
    switchModeBtn.style.display = 'flex';
    
    if (isClassic) {
        // Klasik mod ayarlarƒ±
        document.body.classList.add('classic-mode');
        gameContainer.classList.add('classic-mode');
        document.querySelectorAll('.cell').forEach(cell => {
            cell.classList.add('classic-mode');
        });
        
        // Skor tablosunu g√ºncelle
        document.querySelectorAll('.score-item').forEach((item, index) => {
            const emoji = item.querySelector('.score-emoji');
            const score = item.querySelector('span:nth-child(2)');
            const text = item.lastChild;
            if (index === 0) {
                emoji.textContent = '‚ùå';
                score.textContent = classicScores.x;
                text.textContent = ' Zafer';
            } else {
                emoji.textContent = '‚≠ï';
                score.textContent = classicScores.o;
                text.textContent = ' Zafer';
            }
        });
        
        document.querySelector('.power-ups').style.display = 'none';
        document.querySelector('.moves-left').style.display = 'none';
        document.querySelector('.moving-title').style.display = 'none';
        document.getElementById('developmentBanner').style.display = 'none';
        currentModeText.textContent = 'Arƒ±lƒ± Moda Ge√ß';
        switchModeBtn.classList.add('bee');
        updateBoardLayout();
    } else {
        // Arƒ±lƒ± mod ayarlarƒ±
        document.body.classList.remove('classic-mode');
        gameContainer.classList.remove('classic-mode');
        document.querySelectorAll('.cell').forEach(cell => {
            cell.classList.remove('classic-mode');
            cell.style.backgroundImage = 'url(\'./bal_petek2.png\')';
        });
        document.querySelector('.power-ups').style.display = 'block';
        document.querySelector('.moves-left').style.display = 'block';
        document.querySelector('.moving-title').style.display = 'inline-block';
        document.getElementById('developmentBanner').style.display = 'block';
        gameContainer.classList.add('bee-mode');
        currentModeText.textContent = 'Klasik Moda Ge√ß';
        switchModeBtn.classList.add('classic');
        updateBoardLayout();
    }
}

// Tahtayƒ± yeniden olu≈üturan fonksiyon
function rebuildBoard(newSize) {
    boardSize = newSize;
    const board = document.getElementById('board');
    board.innerHTML = '';
    
    // Tahta boyutuna g√∂re h√ºcre boyutunu ayarla
    const maxBoardWidth = 800; // Maksimum tahta geni≈üliƒüi (piksel)
    const cellSize = Math.min(150, Math.floor((maxBoardWidth - (newSize-1) * 10) / newSize));
    
    // Grid yapƒ±sƒ±nƒ± g√ºncelle
    board.style.gridTemplateColumns = `repeat(${newSize}, ${cellSize}px)`;
    board.style.width = `${newSize * cellSize + (newSize-1) * 10}px`;
    
    // Yeni gameBoard array'ini olu≈ütur
    const totalCells = newSize * newSize;
    gameBoard = new Array(totalCells).fill('');
    
    // Yeni h√ºcreleri olu≈ütur
    for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement('div');
        cell.classList.add('cell');
        cell.setAttribute('data-index', i);
        
        // H√ºcre boyutunu ayarla
        cell.style.width = `${cellSize}px`;
        cell.style.height = `${cellSize}px`;
        cell.style.fontSize = `${cellSize * 0.5}px`; // Emoji boyutunu h√ºcre boyutuna g√∂re ayarla
        
        cell.style.backgroundImage = 'url(\'./bal_petek2.png\')';
        board.appendChild(cell);
        
        // Click event listener'ƒ± ekle
        cell.addEventListener('click', handleBeeMove);
    }

    // Kazanma ko≈üullarƒ±nƒ± g√ºncelle
    updateWinConditions(newSize);
}

// G√º√ß t√ºrlerini g√ºncelleyelim
const POWERS = {
    EXPAND_BOARD: {
        icon: 'üìê',
        name: 'Tahta Geni≈ület',
        description: 'Tahtayƒ± bir birim geni≈ületir',
        effect: (player) => {
            if (boardSize < 8) { // Maksimum 8x8
                boardSize++;
                rebuildBoard(boardSize);
                showPowerNotification(`${player} tahtayƒ± ${boardSize}x${boardSize} yaptƒ±!`);
            }
        }
    }
    // Diƒüer g√º√ßler buraya eklenebilir...
};

// Aktif g√º√ßleri takip etmek i√ßin yapƒ±yƒ± g√ºncelleyelim
let activePowers = [];  // {power, owner, remainingTurns} ≈üeklinde objeler

let moveCounter = 0;
let winCondition = 3;

statusDisplay.textContent = `Sƒ±ra: ${currentPlayer}`;

function handleCellClick(e) {
    // Kazanan ekranƒ± a√ßƒ±kken tƒ±klamalarƒ± engelle
    if (winnerDisplay.classList.contains('active')) {
        return;
    }

    if (isClassicMode) {
        handleClassicMove(e);
    } else {
        handleBeeMove(e);
    }
}

// Klasik XOX hamlesi
function handleClassicMove(e) {
    const clickedCell = e.target;
    const cellIndex = parseInt(clickedCell.getAttribute('data-index'));

    if (!gameActive || gameBoard[cellIndex] !== '') return;

    gameBoard[cellIndex] = currentPlayer;
    clickedCell.textContent = currentPlayer;
    clickSound.play();

    if (checkWin()) {
        handleClassicWin();
        return;
    }

    // Beraberlik kontrol√º
    if (!gameBoard.includes('')) {
        handleDraw();
        return;
    }

    currentPlayer = currentPlayer === '‚ùå' ? '‚≠ï' : '‚ùå';
    statusDisplay.textContent = `Sƒ±ra: ${currentPlayer}`;
}

// Beraberlik durumu i√ßin yeni fonksiyon
function handleDraw() {
    gameActive = false;
    // T√ºm h√ºcreleri tƒ±klanamaz yap
    cells.forEach(cell => {
        cell.style.pointerEvents = 'none';
    });
    
    statusDisplay.textContent = 'Oyun Berabere!';
    winnerEmoji.textContent = 'ü§ù';
    winnerText.textContent = "BERABERE!";
    winnerDisplay.classList.add('active');
    
    // Oyun tahtasƒ±nƒ± temizle
    gameBoard = ['', '', '', '', '', '', '', '', ''];
    cells.forEach(cell => {
        cell.textContent = '';
        if (isClassicMode) {
            cell.style.backgroundColor = '#4CAF50';
        } else {
            cell.style.backgroundColor = '#FFF8DC';
        }
    });
}

// Klasik mod i√ßin ayrƒ± kazanma fonksiyonu
function handleClassicWin() {
    gameActive = false;
    // T√ºm h√ºcreleri tƒ±klanamaz yap
    cells.forEach(cell => {
        cell.style.pointerEvents = 'none';
    });
    
    // Skoru g√ºncelle
    if (currentPlayer === '‚ùå') {
        classicScores.x++;
        beeScoreDisplay.textContent = classicScores.x;
        consecutiveWins.x++;
        consecutiveWins.o = 0;
    } else {
        classicScores.o++;
        honeyScoreDisplay.textContent = classicScores.o;
        consecutiveWins.o++;
        consecutiveWins.x = 0;
    }

    // Kazanan ekranƒ±nƒ± g√∂ster
    statusDisplay.textContent = `Oyunu ${currentPlayer} kazandƒ±!`;
    winnerEmoji.textContent = currentPlayer;
    winnerText.textContent = "KAZANDI!";
    winnerDisplay.classList.add('active');
    
    // Oyun tahtasƒ±nƒ± temizle
    gameBoard = ['', '', '', '', '', '', '', '', ''];
    cells.forEach(cell => {
        cell.textContent = '';
        if (isClassicMode) {
            cell.style.backgroundColor = '#4CAF50';
        }
    });
}

// Arƒ±lƒ± mod i√ßin kazanma fonksiyonunu g√ºncelleyelim
function handleBeeWin() {
    gameActive = false;
    // T√ºm h√ºcreleri tƒ±klanamaz yap
    cells.forEach(cell => {
        cell.style.pointerEvents = 'none';
    });
    
    // Skoru g√ºncelle
    if (currentPlayer === 'üêù') {
        beeScores.bee++;
        beeScoreDisplay.textContent = beeScores.bee;
        beeVictorySound.play();
        consecutiveWins.bee++;
        consecutiveWins.honey = 0;
    } else {
        beeScores.honey++;
        honeyScoreDisplay.textContent = beeScores.honey;
        honeyVictorySound.play();
        consecutiveWins.honey++;
        consecutiveWins.bee = 0;
    }

    // Kazanan ekranƒ±nƒ± g√∂ster
    statusDisplay.textContent = `Oyunu ${currentPlayer} kazandƒ±!`;
    winnerEmoji.textContent = currentPlayer;
    winnerText.textContent = "KAZANDI!";
    winnerDisplay.classList.add('active');
    backgroundMusic.pause();
    
    // Oyun deƒüi≈ükenlerini sƒ±fƒ±rla
    gameBoard = ['', '', '', '', '', '', '', '', ''];
    beeCount = 0;
    honeyCount = 0;
    moveCounter = 0;
    selectedCell = null;
    
    // Tahtayƒ± temizle
    cells.forEach(cell => {
        cell.textContent = '';
        cell.style.backgroundColor = '#FFF8DC';
        cell.style.pointerEvents = 'auto';
    });
    
    // Hamle saya√ßlarƒ±nƒ± g√ºncelle
    updateMovesLeft();
}

// Mevcut arƒ±lƒ± mod hamlesi
function handleBeeMove(e) {
    const clickedCell = e.target;
    const cellIndex = parseInt(clickedCell.getAttribute('data-index'));

    if (!gameActive) return;

    // Se√ßili bir ta≈ü varsa ve bo≈ü bir h√ºcreye ta≈üƒ±nƒ±yorsa
    if (selectedCell !== null) {
        if (gameBoard[cellIndex] === '') {
            gameBoard[cellIndex] = currentPlayer;
            gameBoard[selectedCell] = '';
            clickedCell.textContent = currentPlayer;
            cells[selectedCell].textContent = '';
            cells[selectedCell].style.backgroundColor = '#FFF8DC';
            clickSound.play();

            if (checkWin()) {
                handleBeeWin();
                return;
            }

            selectedCell = null;
            moveCounter++;
            checkForPowerSpawn();
            currentPlayer = currentPlayer === 'üêù' ? 'üçØ' : 'üêù';
            statusDisplay.textContent = `Sƒ±ra: ${currentPlayer}`;
        }
        return;
    }

    // Yeni ta≈ü koyma durumu
    if (gameBoard[cellIndex] === '') {
        // Eƒüer maksimum ta≈ü sayƒ±sƒ±na ula≈üƒ±ldƒ±ysa, sadece ta≈ü hareket ettirmeye izin ver
        if ((currentPlayer === 'üêù' && beeCount >= 3) || 
            (currentPlayer === 'üçØ' && honeyCount >= 3)) {
            statusDisplay.textContent = `${currentPlayer} bir ta≈üƒ±nƒ± se√ß ve hareket ettir!`;
            return;
        }

        let powerUsed = false;
        // G√º√ß kutusu kontrol√º
        if (clickedCell.dataset.power) {
            const powerKey = clickedCell.dataset.power;
            if (powerKey === 'EXPAND_BOARD') {
                const power = POWERS[powerKey];
                collectPower(clickedCell, currentPlayer);
                showPowerNotification(power, currentPlayer);
                delete clickedCell.dataset.power;
                clickedCell.classList.remove('power-active');
                clickedCell.innerHTML = '';
                clickedCell.style.backgroundImage = 'url(\'./bal_petek2.png\')';
                powerUsed = true;
            }
        }

        // Yeni ta≈ü koyma
        gameBoard[cellIndex] = currentPlayer;
        clickedCell.textContent = currentPlayer;
        clickSound.play();

        if (currentPlayer === 'üêù') {
            beeCount++;
        } else {
            honeyCount++;
        }

        updateMovesLeft();
        moveCounter++;
        checkForPowerSpawn();

        if (checkWin()) {
            handleBeeWin();
            return;
        }

        // Eƒüer her iki taraf da maksimum ta≈ü sayƒ±sƒ±na ula≈ütƒ±ysa, sƒ±rayƒ± arƒ±ya ver
        if (beeCount >= 3 && honeyCount >= 3) {
            currentPlayer = 'üêù';
        } else {
            // Eƒüer g√º√ß kullanƒ±lmadƒ±ysa sƒ±rayƒ± deƒüi≈ütir
            if (!powerUsed) {
                currentPlayer = currentPlayer === 'üêù' ? 'üçØ' : 'üêù';
            }
        }
        
        statusDisplay.textContent = `Sƒ±ra: ${currentPlayer}`;
    }
    // Kendi ta≈üƒ±nƒ± se√ßme durumu
    else if (gameBoard[cellIndex] === currentPlayer) {
        // Sadece maksimum ta≈ü sayƒ±sƒ±na ula≈üƒ±ldƒ±ƒüƒ±nda ta≈ü se√ßimine izin ver
        if ((currentPlayer === 'üêù' && beeCount >= 3) || 
            (currentPlayer === 'üçØ' && honeyCount >= 3)) {
            selectedCell = cellIndex;
            clickedCell.style.backgroundColor = '#90EE90';
        }
    }
}

function checkWin() {
    return winConditions.some(condition => {
        const requiredMatches = winCondition; // 3 veya 4
        const matches = condition.filter(index => gameBoard[index] === currentPlayer);
        return matches.length >= requiredMatches;
    });
}

function handleWin() {
    gameActive = false;
    statusDisplay.textContent = `Oyunu ${currentPlayer} kazandƒ±!`;
    winnerEmoji.textContent = currentPlayer;
    winnerText.textContent = "KAZANDI!";
    winnerDisplay.classList.add('active');
    
    backgroundMusic.pause();
    
    if (currentPlayer === 'üêù') {
        beeScore++;
        beeScoreDisplay.textContent = beeScore;
        beeVictorySound.play();
    } else {
        honeyScore++;
        honeyScoreDisplay.textContent = honeyScore;
        honeyVictorySound.play();
    }
}

function restartGame() {
    gameBoard = ['', '', '', '', '', '', '', '', ''];
    gameActive = true;
    selectedCell = null;
    
    if (isClassicMode) {
        // Klasik mod i√ßin ba≈ülangƒ±√ß oyuncusunu belirle
        if (consecutiveWins.x >= 3) {
            currentPlayer = '‚≠ï';
            consecutiveWins.x = 0;
        } else if (consecutiveWins.o >= 3) {
            currentPlayer = '‚ùå';
            consecutiveWins.o = 0;
        } else {
            // Son kazanan ba≈ülar (ilk oyunda X ba≈ülar)
            currentPlayer = consecutiveWins.x > consecutiveWins.o ? '‚ùå' : 
                          consecutiveWins.o > consecutiveWins.x ? '‚≠ï' : '‚ùå';
        }
    } else {
        // Arƒ±lƒ± mod i√ßin ba≈ülangƒ±√ß oyuncusunu belirle
        if (consecutiveWins.bee >= 3) {
            currentPlayer = 'üçØ';
            consecutiveWins.bee = 0;
        } else if (consecutiveWins.honey >= 3) {
            currentPlayer = 'üêù';
            consecutiveWins.honey = 0;
        } else {
            // Son kazanan ba≈ülar (ilk oyunda arƒ± ba≈ülar)
            currentPlayer = consecutiveWins.bee > consecutiveWins.honey ? 'üêù' : 
                          consecutiveWins.honey > consecutiveWins.bee ? 'üçØ' : 'üêù';
        }
    }
    
    // ... diƒüer sƒ±fƒ±rlama kodlarƒ± ...
    
    statusDisplay.textContent = `Sƒ±ra: ${currentPlayer}`;
    
    // T√ºm h√ºcreleri tekrar tƒ±klanabilir yap
    cells.forEach(cell => {
        cell.style.pointerEvents = 'auto';
    });
}

// Sayfa y√ºklendiƒüinde ses ayarlarƒ±nƒ± yapƒ±landƒ±r
document.addEventListener('DOMContentLoaded', function() {
    const allSoundElements = [
        backgroundMusic,
        clickSound,
        beeVictorySound,
        honeyVictorySound
    ];

    // Ba≈ülangƒ±√ßta sesi kapalƒ± olarak ayarla
    volumeSlider.value = 0; // Slider en a≈üaƒüƒ±da
    previousVolume = 25; // √ñnceki ses seviyesini sakla

    // T√ºm ses elementlerinin ba≈ülangƒ±√ß seviyesini 0 yap
    allSoundElements.forEach(sound => {
        sound.volume = 0;
    });

    // Ses simgesini ayarla
    muteButton.textContent = 'üîà';
    muteButton.classList.add('muted');
});

// Volume slider'ƒ± hareket ettirildiƒüinde
volumeSlider.addEventListener('input', (e) => {
    e.stopPropagation();
    clearTimeout(sliderTimeout);
    const volume = (100 - e.target.value) / 100; // Slider ters √ßevrildiƒüi i√ßin deƒüeri de ters √ßevir
    
    // Ses seviyesini ayarla
    const allSoundElements = [
        backgroundMusic,
        clickSound,
        beeVictorySound,
        honeyVictorySound
    ];

    // Eƒüer ses yeni a√ßƒ±lƒ±yorsa (0'dan farklƒ± bir deƒüere ge√ßi≈ü)
    if (muteButton.classList.contains('muted') && volume > 0) {
        volumeSlider.value = 75; // %25 ses i√ßin 75 deƒüeri (ters √ßalƒ±≈ütƒ±ƒüƒ± i√ßin)
        allSoundElements.forEach(sound => {
            sound.volume = 0.25; // %25 ses seviyesi
        });
        muteButton.classList.remove('muted');
        muteButton.textContent = 'üîä';
        return; // Fonksiyondan √ßƒ±k
    }

    // Normal ses ayarƒ±
    allSoundElements.forEach(sound => {
        sound.volume = volume;
    });

    // Ses kapalƒ±ysa hoparl√∂r ikonunu g√ºncelle
    if (volume === 0) {
        muteButton.classList.add('muted');
        muteButton.textContent = 'üîà';
    } else {
        muteButton.classList.remove('muted');
        muteButton.textContent = 'üîä';
    }
});

// Volume slider'da mouse basƒ±lƒ± tutulduƒüunda
volumeSlider.addEventListener('mousedown', () => {
    isSliderDragging = true;
    clearTimeout(sliderTimeout);
});

// Mouse bƒ±rakƒ±ldƒ±ƒüƒ±nda
document.addEventListener('mouseup', () => {
    if (isSliderDragging) {
        isSliderDragging = false;
    }
});

// Slider'ƒ± kapatma fonksiyonu
function closeSlider() {
    // Mouse slider √ºzerinde deƒüilse VE slider s√ºr√ºklenmiyorsa kapat
    if (!slider.matches(':hover') && !isSliderDragging) {
        slider.classList.remove('open');
        musicIcon.classList.remove('hidden');
        clearTimeout(sliderTimeout);
    }
}

// Ses kontrollerini g√ºncelleyelim
muteButton.addEventListener('click', () => {
    const isMuted = muteButton.classList.contains('muted');
    if (!isMuted) {
        // Sesi kapat
        previousVolume = volumeSlider.value;
        volumeSlider.value = 100; // Sesi tamamen kƒ±s
        muteButton.classList.add('muted');
        muteButton.textContent = 'üîà';
        const allSoundElements = [
            backgroundMusic,
            clickSound,
            beeVictorySound,
            honeyVictorySound
        ];
        allSoundElements.forEach(sound => {
            sound.volume = 0;
        });
    } else {
        // Sesi a√ß
        volumeSlider.value = previousVolume;
        muteButton.classList.remove('muted');
        muteButton.textContent = 'üîä';
        const volume = (100 - previousVolume) / 100;
        const allSoundElements = [
            backgroundMusic,
            clickSound,
            beeVictorySound,
            honeyVictorySound
        ];
        allSoundElements.forEach(sound => {
            sound.volume = volume;
        });
    }
});

// Volume slider'da mouse basƒ±lƒ± tutulduƒüunda timeout'u durdur
volumeSlider.addEventListener('mousedown', () => {
    isSliderDragging = true;
    clearTimeout(sliderTimeout);
});

// Mouse bƒ±rakƒ±ldƒ±ƒüƒ±nda timeout'u ba≈ülatma
document.addEventListener('mouseup', () => {
    if (isSliderDragging) {
        isSliderDragging = false;
        // Slider'ƒ± kullanƒ±rken timeout'u ba≈ülatma
    }
});

// Slider'a tƒ±klandƒ±ƒüƒ±nda
slider.addEventListener('click', (e) => {
    e.stopPropagation();
    if (!isSliderDragging) {
        resetSliderTimeout();
    }
    
    if (e.offsetX < 0) {
        closeSlider();
    }
});

// Slider'ƒ±n √ºzerinde fare hareket ettiƒüinde
slider.addEventListener('mousemove', () => {
    if (isSliderDragging) {
        clearTimeout(sliderTimeout);
    }
});

// Document'a tƒ±klandƒ±ƒüƒ±nda slider'ƒ± kapat
document.addEventListener('click', () => {
    // Mouse slider √ºzerinde deƒüilse VE slider s√ºr√ºklenmiyorsa kapat
    if (!slider.matches(':hover') && !isSliderDragging) {
        closeSlider();
    }
});

// Volume slider'ƒ± hareket ettirildiƒüinde
volumeSlider.addEventListener('input', (e) => {
    e.stopPropagation();
    clearTimeout(sliderTimeout);
    const volume = (100 - e.target.value) / 100; // Deƒüeri ters √ßevir
    
    // Ses seviyesini ayarla
    const allSoundElements = [
        backgroundMusic,
        clickSound,
        beeVictorySound,
        honeyVictorySound
    ];
    allSoundElements.forEach(sound => {
        sound.volume = volume;
    });

    // Ses kapalƒ±ysa hoparl√∂r ikonunu g√ºncelle
    if (volume === 0) {
        muteButton.classList.add('muted');
        muteButton.textContent = 'üîà';
    } else {
        muteButton.classList.remove('muted');
        muteButton.textContent = 'üîä';
    }
});

// Slider'ƒ± kapatma fonksiyonu
function closeSlider() {
    slider.classList.remove('open');
    musicIcon.classList.remove('hidden');
    clearTimeout(sliderTimeout);
}

// Slider timeout'unu sƒ±fƒ±rlama fonksiyonu
function resetSliderTimeout() {
    // Mouse slider √ºzerinde deƒüilse VE slider s√ºr√ºklenmiyorsa timeout'u ba≈ülat
    if (!slider.matches(':hover') && !isSliderDragging) {
        clearTimeout(sliderTimeout);
        sliderTimeout = setTimeout(() => {
            closeSlider();
        }, 3000);
    }
}

// Slider'ƒ±n √ºzerinde mouse varken s√ºreyi durdur
slider.addEventListener('mouseenter', () => {
    clearTimeout(sliderTimeout); // Mouse √ºzerindeyken s√ºreyi temizle
});

// Slider'dan mouse √ßƒ±kƒ±nca s√ºreyi ba≈ülat
slider.addEventListener('mouseleave', () => {
    resetSliderTimeout(); // Mouse √ßƒ±kƒ±nca s√ºreyi ba≈ülat
});

// Document'a tƒ±klandƒ±ƒüƒ±nda slider'ƒ± kapat
document.addEventListener('click', () => {
    if (!slider.matches(':hover')) { // Mouse slider √ºzerinde deƒüilse kapat
        closeSlider();
    }
});

cells.forEach(cell => cell.addEventListener('click', handleCellClick));
restartBtn.addEventListener('click', restartGame);
winnerDisplay.addEventListener('click', function() {
    this.classList.remove('active');
    restartGame();
});

resetScoresBtn.addEventListener('click', function() {
    if (isClassicMode) {
        classicScores.x = 0;
        classicScores.o = 0;
        beeScoreDisplay.textContent = '0';
        honeyScoreDisplay.textContent = '0';
    } else {
        beeScores.bee = 0;
        beeScores.honey = 0;
        beeScoreDisplay.textContent = '0';
        honeyScoreDisplay.textContent = '0';
    }
});

function updateMovesLeft() {
    beeMovesLeft.textContent = Math.max(0, 3 - beeCount);
    honeyMovesLeft.textContent = Math.max(0, 3 - honeyCount);
}

function checkForPowerSpawn() {
    if (isClassicMode || moveCounter <= 6) return; // Klasik modda g√º√ß √ßƒ±kmasƒ±n
    
    if (moveCounter % 2 === 0) {
        const emptyCells = Array.from(cells).filter(cell => 
            !cell.textContent && !cell.dataset.power && !cell.classList.contains('power-active')
        );
        
        if (emptyCells.length > 0) {
            const randomPower = getRandomPower();
            if (randomPower) {
                const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                
                // G√º√ß atamasƒ± ba≈üarƒ±lƒ± olduƒüunda soru i≈üareti ekle
                if (randomCell && POWERS[randomPower]) {
                    randomCell.dataset.power = randomPower;
                    randomCell.classList.add('power-active');
                    
                    const questionMark = document.createElement('div');
                    questionMark.className = 'power-icon';
                    questionMark.textContent = '‚ùì';
                    randomCell.appendChild(questionMark);
                    
                    console.log('G√º√ß olu≈üturuldu:', randomPower);
                }
            }
        }
    }
}

function spawnPowerUp() {
    const powerCells = document.querySelectorAll('.power-cell');
    powerCells.forEach(cell => {
        if (!cell.dataset.power) {
            const randomPower = getRandomPower();
            cell.dataset.power = randomPower;
            cell.style.opacity = '1';
        }
    });
}

function getRandomPower() {
    // ≈ûu anki duruma g√∂re √ßƒ±kabilecek g√º√ßleri filtrele
    const availablePowers = Object.entries(POWERS).filter(([key, power]) => power.condition());
    
    if (availablePowers.length === 0) return null;
    
    // Tahta geni≈ületme buff'ƒ± i√ßin √∂zel olasƒ±lƒ±k
    const random = Math.random();
    if (random < 0.4 && !isExpandedBoard) {  // %40 olasƒ±lƒ±kla tahta geni≈ületme √ßƒ±ksƒ±n
        return 'EXPAND_BOARD';
    }
    
    // Diƒüer g√º√ßler i√ßin rastgele se√ßim
    const randomIndex = Math.floor(Math.random() * availablePowers.length);
    return availablePowers[randomIndex][0];
}

function collectPower(cell, player) {
    const powerKey = cell.dataset.power;
    const power = POWERS[powerKey];
    if (power) {
        power.effect(player);
        // G√º√ß kullanƒ±ldƒ±ktan sonra h√ºcreyi temizle
        delete cell.dataset.power;
        cell.classList.remove('power-active');
        cell.textContent = '';
    }
}

function updateActivePowersDisplay() {
    const powersList = document.querySelector('.active-powers');
    powersList.innerHTML = '';
    activePowers.forEach((powerInstance, index) => {
        const powerElement = document.createElement('div');
        powerElement.className = 'power-item';
        powerElement.innerHTML = `
            <span class="power-owner">${powerInstance.owner}</span>
            <span class="power-name">${powerInstance.name}</span>
            ${powerInstance.remainingTurns ? 
                `<span class="power-duration">${powerInstance.remainingTurns} tur</span>` : 
                '<span class="power-duration">‚àû</span>'}
        `;
        powerElement.onclick = () => usePower(index);
        powersList.appendChild(powerElement);
    });
}

function usePower(index) {
    const powerInstance = activePowers[index];
    let used = false;

    if (powerInstance.targetOpponent) {
        // ... mevcut rakip hedefli g√º√ß kodu ...
        return;
    }

    switch(powerInstance.name) {
        case 'Tahta Geni≈ületme':
            if (!isExpandedBoard) {
                isExpandedBoard = true;
                const newSize = boardSize + 1; // 3x3'ten 4x4'e
                rebuildBoard(newSize);
                
                // Kazanma ko≈üullarƒ±nƒ± g√ºncelle
                updateWinConditions(newSize);
                
                used = true;
                showPowerNotification({
                    name: 'Tahta Geni≈ületildi',
                    description: `Oyun tahtasƒ± ${newSize}x${newSize} boyutuna geni≈ületildi!`,
                    type: 'buff'
                });
            }
            break;
        // ... diƒüer g√º√ßler ...
    }

    if (used) {
        activePowers.splice(index, 1);
        updateActivePowersDisplay();
    }
}

function showPowerNotification(power, owner) {
    const notification = document.createElement('div');
    notification.className = 'power-notification';
    notification.innerHTML = `
        <div class="power-info">
            <span class="power-owner">${owner}</span>
            <h4>${power.name}</h4>
            <p>${power.description}</p>
            <span class="power-type">${power.type === 'buff' ? 'üí™ Buff' : 'üíÄ Debuff'}</span>
            ${power.duration ? `<span class="power-duration">${power.duration} tur</span>` : ''}
        </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 500);
    }, 2000);
}

// Her tur sonunda g√º√ßlerin s√ºresini azalt
function updatePowerDurations() {
    activePowers = activePowers.filter(powerInstance => {
        if (powerInstance.remainingTurns === null) return true;
        powerInstance.remainingTurns--;
        return powerInstance.remainingTurns > 0;
    });
    updateActivePowersDisplay();
}

// Kazanma ko≈üullarƒ±nƒ± g√ºncelleyen fonksiyon
function updateWinConditions(size) {
    winConditions = [];
    
    // Yatay kazanma ko≈üullarƒ±
    for (let i = 0; i < size; i++) {
        const row = [];
        for (let j = 0; j < size; j++) {
            row.push(i * size + j);
        }
        winConditions.push(row);
    }
    
    // Dikey kazanma ko≈üullarƒ±
    for (let i = 0; i < size; i++) {
        const col = [];
        for (let j = 0; j < size; j++) {
            col.push(j * size + i);
        }
        winConditions.push(col);
    }
    
    // √áapraz kazanma ko≈üullarƒ±
    const diag1 = [];
    const diag2 = [];
    for (let i = 0; i < size; i++) {
        diag1.push(i * size + i);
        diag2.push(i * size + (size - 1 - i));
    }
    winConditions.push(diag1);
    winConditions.push(diag2);
}

// Mod deƒüi≈ütirme olayƒ±nƒ± ekleyelim
switchModeBtn.addEventListener('click', () => {
    isClassicMode = !isClassicMode;
    switchGameMode();
});

function switchGameMode() {
    // Oyunu sƒ±fƒ±rla
    restartGameWithoutMusic();
    
    if (isClassicMode) {
        document.body.classList.add('classic-mode');
        // Klasik mod ayarlarƒ±
        currentPlayer = '‚ùå';
        currentModeText.textContent = 'Arƒ±lƒ± Moda Ge√ß';
        gameContainer.classList.add('classic-mode');
        
        // G√∂r√ºn√ºm ayarlarƒ±
        document.querySelectorAll('.cell').forEach(cell => {
            cell.classList.add('classic-mode');
        });
        
        // Skor tablosunu g√ºncelle
        document.querySelectorAll('.score-item').forEach((item, index) => {
            const emoji = item.querySelector('.score-emoji');
            const score = item.querySelector('span:nth-child(2)');
            const text = item.lastChild;
            if (index === 0) {
                emoji.textContent = '‚ùå';
                score.textContent = classicScores.x;
                text.textContent = ' Zafer';
            } else {
                emoji.textContent = '‚≠ï';
                score.textContent = classicScores.o;
                text.textContent = ' Zafer';
            }
        });
        
        document.querySelector('.power-ups').style.display = 'none';
        document.querySelector('.moves-left').style.display = 'none';
        document.querySelector('.moving-title').style.display = 'none';
        document.getElementById('developmentBanner').style.display = 'none';
        switchModeBtn.classList.remove('classic');
        switchModeBtn.classList.add('bee');
        updateBoardLayout();
    } else {
        document.body.classList.remove('classic-mode');
        // Arƒ±lƒ± mod ayarlarƒ±
        currentPlayer = 'üêù';
        currentModeText.textContent = 'Klasik Moda Ge√ß';
        gameContainer.classList.remove('classic-mode');
        
        // G√∂r√ºn√ºm ayarlarƒ±
        document.querySelectorAll('.cell').forEach(cell => {
            cell.classList.remove('classic-mode');
            cell.style.backgroundImage = 'url(\'./bal_petek2.png\')';
        });
        
        // Gizlenen elementleri g√∂ster
        document.querySelector('.power-ups').style.display = 'block';
        document.querySelector('.moves-left').style.display = 'block';
        document.querySelector('.power-spawn-points').style.display = 'block';
        
        // Skor tablosunu g√ºncelle
        document.querySelectorAll('.score-emoji').forEach((emoji, index) => {
            emoji.textContent = index === 0 ? 'üêù' : 'üçØ';
        });
        
        // Arƒ±lƒ± mod skorlarƒ±nƒ± g√∂ster
        beeScoreDisplay.textContent = beeScores.bee;
        honeyScoreDisplay.textContent = beeScores.honey;
        
        document.querySelectorAll('.score-item').forEach((item, index) => {
            const emoji = item.querySelector('.score-emoji');
            const score = item.querySelector('span:nth-child(2)');
            if (index === 0) {
                emoji.textContent = 'üêù';
                score.textContent = beeScores.bee;
            } else {
                emoji.textContent = 'üçØ';
                score.textContent = beeScores.honey;
            }
        });
        
        document.querySelector('.moving-title').style.display = 'inline-block';
        document.getElementById('developmentBanner').style.display = 'block';
        gameContainer.classList.add('bee-mode');
        switchModeBtn.classList.remove('bee');
        switchModeBtn.classList.add('classic');
        updateBoardLayout();
    }
    
    // Durum metnini g√ºncelle
    statusDisplay.textContent = `Sƒ±ra: ${currentPlayer}`;
}

// M√ºziƒüi ba≈ülatmadan oyunu yeniden ba≈ülatan fonksiyon
function restartGameWithoutMusic() {
    gameBoard = ['', '', '', '', '', '', '', '', ''];
    gameActive = true;
    selectedCell = null;
    
    if (isClassicMode) {
        currentPlayer = '‚ùå';
    } else {
        currentPlayer = 'üêù';
        beeCount = 0;
        honeyCount = 0;
        moveCounter = 0;
        activePowers = [];
    }
    
    cells.forEach(cell => {
        cell.textContent = '';
        if (isClassicMode) {
            cell.style.backgroundColor = '#4CAF50';  // Klasik modda ye≈üil
        } else {
            cell.style.backgroundColor = '#FFF8DC';  // Arƒ±lƒ± modda orijinal renk
        }
    });
    
    statusDisplay.textContent = `Sƒ±ra: ${currentPlayer}`;
    winnerDisplay.classList.remove('active');
}

// Sayfa y√ºklendiƒüinde mode-select sƒ±nƒ±fƒ±nƒ± ekle
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('mode-select');
    // ... diƒüer kodlar ...
});

// HTML'deki board yapƒ±sƒ±nƒ± g√ºncelleyelim
function updateBoardLayout() {
    const board = document.getElementById('board');
    const powerSpawnPoints = document.querySelector('.power-spawn-points');
    
    if (isClassicMode) {
        // Klasik modda power-spawn-points'i gizle ve board boyutunu ayarla
        if (powerSpawnPoints) {
            powerSpawnPoints.style.display = 'none';
        }
        board.style.width = '470px';  // Normal 3x3 boyutu
    } else {
        // Arƒ±lƒ± modda power-spawn-points'i g√∂ster
        if (powerSpawnPoints) {
            powerSpawnPoints.style.display = 'block';
        }
        board.style.width = '470px';  // Normal boyut
    }
}

// M√ºzik ikonuna tƒ±klandƒ±ƒüƒ±nda
musicIcon.addEventListener('click', (e) => {
    e.stopPropagation();
    slider.classList.toggle('open');
    musicIcon.classList.toggle('hidden');
    resetSliderTimeout();
});

// Volume slider'da mouse basƒ±lƒ± tutulduƒüunda
volumeSlider.addEventListener('mousedown', () => {
    isSliderDragging = true;
    clearTimeout(sliderTimeout);
});

// Mouse bƒ±rakƒ±ldƒ±ƒüƒ±nda
document.addEventListener('mouseup', () => {
    if (isSliderDragging) {
        isSliderDragging = false;
    }
});

// Slider'ƒ±n √ºzerinde fare hareket ettiƒüinde
slider.addEventListener('mousemove', () => {
    if (isSliderDragging) {
        clearTimeout(sliderTimeout);
    }
});

// Document'a tƒ±klandƒ±ƒüƒ±nda slider'ƒ± kapat
document.addEventListener('click', () => {
    // Mouse slider √ºzerinde deƒüilse VE slider s√ºr√ºklenmiyorsa kapat
    if (!slider.matches(':hover') && !isSliderDragging) {
        closeSlider();
    }
});

// Volume slider'ƒ± hareket ettirildiƒüinde
volumeSlider.addEventListener('input', (e) => {
    e.stopPropagation();
    clearTimeout(sliderTimeout);
    const volume = (100 - e.target.value) / 100; // Slider ters √ßevrildiƒüi i√ßin deƒüeri de ters √ßevir
    
    // Ses seviyesini ayarla
    const allSoundElements = [
        backgroundMusic,
        clickSound,
        beeVictorySound,
        honeyVictorySound
    ];
    allSoundElements.forEach(sound => {
        sound.volume = volume;
    });

    // Ses kapalƒ±ysa hoparl√∂r ikonunu g√ºncelle
    if (volume === 0) {
        muteButton.classList.add('muted');
        muteButton.textContent = 'üîà';
    } else {
        // Eƒüer ses yeni a√ßƒ±lƒ±yorsa (0'dan farklƒ± bir deƒüere ge√ßi≈ü)
        if (muteButton.classList.contains('muted')) {
            volumeSlider.value = 75; // Slider ters olduƒüu i√ßin 75 yapƒ±yoruz (%25 ses i√ßin)
            allSoundElements.forEach(sound => {
                sound.volume = 0.25;
            });
        }
        muteButton.classList.remove('muted');
        muteButton.textContent = 'üîä';
    }
});

// Slider'ƒ± kapatma fonksiyonu
function closeSlider() {
    slider.classList.remove('open');
    musicIcon.classList.remove('hidden');
    clearTimeout(sliderTimeout);
}

// Slider timeout'unu sƒ±fƒ±rlama fonksiyonu
function resetSliderTimeout() {
    // Mouse slider √ºzerinde deƒüilse VE slider s√ºr√ºklenmiyorsa timeout'u ba≈ülat
    if (!slider.matches(':hover') && !isSliderDragging) {
        clearTimeout(sliderTimeout);
        sliderTimeout = setTimeout(() => {
            closeSlider();
        }, 3000);
    }
}

// Slider'ƒ±n √ºzerinde mouse varken s√ºreyi durdur
slider.addEventListener('mouseenter', () => {
    clearTimeout(sliderTimeout); // Mouse √ºzerindeyken s√ºreyi temizle
});

// Slider'dan mouse √ßƒ±kƒ±nca s√ºreyi ba≈ülat
slider.addEventListener('mouseleave', () => {
    resetSliderTimeout(); // Mouse √ßƒ±kƒ±nca s√ºreyi ba≈ülat
});

// Document'a tƒ±klandƒ±ƒüƒ±nda slider'ƒ± kapat
document.addEventListener('click', () => {
    if (!slider.matches(':hover')) { // Mouse slider √ºzerinde deƒüilse kapat
        closeSlider();
    }
});

// Oyun ba≈ülangƒ±cƒ±nda board'u olu≈ütur
function initializeBoard() {
    const board = document.getElementById('board');
    board.style.gridTemplateColumns = 'repeat(3, 150px)'; // Ba≈ülangƒ±√ßta 3x3
    board.style.width = '470px'; // 3 h√ºcre + bo≈üluklar

    // Diƒüer ba≈ülangƒ±√ß ayarlarƒ±...
}

// Sayfa y√ºklendiƒüinde √ßaƒüƒ±r
document.addEventListener('DOMContentLoaded', initializeBoard); 